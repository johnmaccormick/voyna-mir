<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Supabase demo</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  </head>
  <body>
    <h1>Supabase demo</h1>

    <div id="authContainer">
      <h2>Sign-up and login</h2>

      <p>
        By default, only dickinson.edu email addresses are permitted. To use a
        different email address, please contact the database administrator.
      </p>

      <label for="email">Email:</label>
      <input id="email" type="email" placeholder="Your email" />
      <label for="password">Password:</label>
      <input id="password" type="password" placeholder="Your password" />
      <button id="signupBtn">Sign Up</button>
      <button id="loginBtn">Log In</button>
      <p id="authStatus"></p>
    </div>

    <div id="logoutContainer" style="display: none">
      <p id="userMessage"></p>
      <button id="logoutBtn">Log Out</button>
    </div>

    <div id="forgotPwdContainer">
      <h3>Forgot Password?</h3>
      <p>Enter your email above to receive a password reset link.</p>
      <button id="resetPasswordBtn">Reset Password</button>
      <p id="resetStatus"></p>
    </div>

    <h2>Demo actions</h2>

    <ul>
      <li><a href="single-character.html">name of one character</a></li>
      <li>
        <a href="single-character-with-russian.html"
          >name of one character in English and Russian</a
        >
      </li>
      <li>
        <a href="all-characters.html"
          >Russian and English names of all characters</a
        >
      </li>
      <li>
        <a href="all-chars-schema.html">Same, but from the voyna-mir schema</a>
        (previous demos used the public schema)
      </li>
      <li>
        <a href="insert-person.html"
          >Insert a new person into the people table</a
        >
      </li>
      <li>
        <a href="update-person.html"
          >Update age of a person in the people table</a
        >
      </li>
      <li>
        <a href="single-person-RLS.html"
          >Display name of one person in people2 table (with RLS)</a
        >
      </li>
      <li>
        <a href="insert-person-RLS.html"
          >Insert a new person into the people2 table (with RLS)</a
        >
      </li>
      <li>
        <a href="update-person-RLS.html"
          >Update age of a person in the people2 table (with RLS)</a
        >
      </li>
    </ul>

    <script type="module">
      import { client } from "./supabaseClient.js";

      const authContainer = document.getElementById("authContainer");
      const logoutContainer = document.getElementById("logoutContainer");
      const forgotPwdContainer = document.getElementById("forgotPwdContainer");
      const userMessage = document.getElementById("userMessage");

      // Function to check if a user is logged in and update the UI
      async function checkUserSession() {
        const {
          data: { user },
        } = await client.auth.getUser();
        if (user) {
          authContainer.style.display = "none";
          logoutContainer.style.display = "block";
          forgotPwdContainer.style.display = "none";
          userMessage.textContent = "You are logged in as: " + user.email;
        } else {
          authContainer.style.display = "block";
          forgotPwdContainer.style.display = "block";
          logoutContainer.style.display = "none";
        }
      }

      function isValidEmailDomain(email) {

        const emailRegex =
          /^[a-zA-Z0-9._%+-]+@(dickinson\.edu|arawatabill\.org)$/;

        return emailRegex.test(email);
      }

      // Event listener for sign-up
      document
        .getElementById("signupBtn")
        .addEventListener("click", async () => {
          const email = document.getElementById("email").value;
          const password = document.getElementById("password").value;

          if (!isValidEmailDomain(email)) {
            document.getElementById("authStatus").textContent =
              "Please use a dickinson.edu email address.";
            return;
          }

          const { data, error } = await client.auth.signUp({
            email: email,
            password: password,
          });

          console.log("Data:", data);
          console.log("Error:", error);

          if (error) {
            document.getElementById(
              "authStatus"
            ).textContent = `There was an error during sign-up. Perhaps the email address is invalid.\n 
              The error message from the database server was: \n"${error.message}"`;
          } else {
            document.getElementById("authStatus").textContent =
              "Check your email for a confirmation link!";
          }
        });

      // Event listener for log in
      document
        .getElementById("loginBtn")
        .addEventListener("click", async () => {
          const email = document.getElementById("email").value;
          const password = document.getElementById("password").value;

          const { data, error } = await client.auth.signInWithPassword({
            email: email,
            password: password,
          });

          console.log("Data:", data);
          console.log("Error:", error);

          if (error) {
            document.getElementById("authStatus").textContent =
              "Error: " + error.message;
          } else {
            document.getElementById("authStatus").textContent =
              "Successfully logged in.";
            await new Promise((resolve) => setTimeout(resolve, 2000)); // Wait for 2 seconds
            checkUserSession(); // Update UI after login
          }
        });

      // Event listener for password reset
      document
        .getElementById("resetPasswordBtn")
        .addEventListener("click", async () => {
          const email = document.getElementById("email").value;

          const { error } = await client.auth.resetPasswordForEmail(email, {
            redirectTo: window.location.origin + "/update-password.html",
          });

          if (error) {
            document.getElementById("resetStatus").textContent =
              "Error: " + error.message;
          } else {
            document.getElementById("resetStatus").textContent =
              "If the email is registered to an existing account, a password reset email was sent.";
          }
        });

      // Event listener for logout
      document
        .getElementById("logoutBtn")
        .addEventListener("click", async () => {
          const { error } = await client.auth.signOut();
          if (error) {
            console.error("Logout error:", error.message);
          } else {
            // Redirect or simply refresh the page to show the login form
            window.location.reload();
          }
        });

      // Initial check on page load
      checkUserSession();

      // Listen for auth state changes to update the UI in real-time
      client.auth.onAuthStateChange((event, session) => {
        if (event === "SIGNED_OUT") {
          window.location.reload();
        }
      });
    </script>
  </body>
</html>
